# 连接参数记忆功能说明

## 功能概述

为MongoDB Compass应用添加了连接参数记忆功能，能够自动保存用户的连接信息，并在下次启动时提供自动重连选项，大大提升用户体验。

## 主要功能

### 1. 自动保存连接参数
- **连接字符串保存**: 自动保存完整的MongoDB连接字符串
- **数据库名称保存**: 记录连接的目标数据库名称
- **连接时间记录**: 记录最后一次成功连接的时间戳
- **持久化存储**: 配置信息保存到用户应用数据目录，重启应用后仍然有效

### 2. 智能自动重连提示
- **启动检测**: 应用启动时自动检测上次连接记录
- **时效性验证**: 只对24小时内的连接记录显示重连提示
- **用户友好**: 显示连接目标和时间信息，让用户做出明智选择
- **延迟显示**: 避免在窗口初始化时显示，确保用户界面完全加载

### 3. 手动重连功能
- **工具栏按钮**: 新增"重新连接"按钮，方便用户随时重连
- **确认对话框**: 显示连接详情，让用户确认后再执行重连
- **智能断开**: 重连前自动断开当前连接，避免资源冲突
- **状态反馈**: 实时显示重连进度和结果

### 4. 安全性保护
- **敏感信息隐藏**: 显示连接信息时隐藏用户名和密码
- **连接字符串安全**: 完整保存连接字符串但不在界面直接显示
- **错误处理**: 完善的异常处理机制，确保功能稳定性

## 技术实现

### 1. 新增字段
```csharp
// 记忆上次连接的参数
private string lastConnectionString = string.Empty;
private string lastDatabaseName = string.Empty;
private DateTime lastConnectionTime = DateTime.MinValue;
```

### 2. 自动保存逻辑
```csharp
// 在ConnectToMongoDB方法中自动保存
lastConnectionString = connectionString;
lastDatabaseName = databaseName;
lastConnectionTime = DateTime.Now;
SaveLastConnectionParams();
```

### 3. 启动时自动加载
```csharp
// 在构造函数中调用
LoadLastConnectionParams();
ShowAutoReconnectPrompt();
```

## 核心方法详解

### 1. SaveLastConnectionParams - 保存连接参数
```csharp
private void SaveLastConnectionParams()
{
    try
    {
        string configPath = GetConnectionConfigFilePath();
        string configDir = Path.GetDirectoryName(configPath);
        
        // 确保配置目录存在
        if (!Directory.Exists(configDir))
        {
            Directory.CreateDirectory(configDir);
        }
        
        // 创建连接配置内容
        var connectionConfig = new StringBuilder();
        connectionConfig.AppendLine("[LastConnection]");
        connectionConfig.AppendLine(string.Format("ConnectionString={0}", lastConnectionString));
        connectionConfig.AppendLine(string.Format("DatabaseName={0}", lastDatabaseName));
        connectionConfig.AppendLine(string.Format("ConnectionTime={0}", lastConnectionTime.ToString("yyyy-MM-dd HH:mm:ss")));
        
        // 保存到配置文件
        File.WriteAllText(configPath, connectionConfig.ToString(), Encoding.UTF8);
        SetStatus(string.Format("已保存连接参数配置: {0}", GetConnectionDisplayName()), Color.Green);
    }
    catch (Exception ex)
    {
        SetStatus(string.Format("保存连接参数配置失败: {0}", ex.Message), Color.Orange);
    }
}
```

### 2. LoadLastConnectionParams - 加载连接参数
```csharp
private void LoadLastConnectionParams()
{
    try
    {
        string configPath = GetConnectionConfigFilePath();
        
        if (File.Exists(configPath))
        {
            var lines = File.ReadAllLines(configPath, Encoding.UTF8);
            bool inLastConnectionSection = false;
            
            foreach (var line in lines)
            {
                var trimmedLine = line.Trim();
                if (trimmedLine == "[LastConnection]")
                {
                    inLastConnectionSection = true;
                    continue;
                }
                
                if (inLastConnectionSection && trimmedLine.Contains("="))
                {
                    var parts = trimmedLine.Split(new[] { '=' }, 2);
                    if (parts.Length == 2)
                    {
                        switch (parts[0])
                        {
                            case "ConnectionString":
                                lastConnectionString = parts[1];
                                break;
                            case "DatabaseName":
                                lastDatabaseName = parts[1];
                                break;
                            case "ConnectionTime":
                                if (DateTime.TryParse(parts[1], out DateTime connectionTime))
                                {
                                    lastConnectionTime = connectionTime;
                                }
                                break;
                        }
                    }
                }
            }
            
            if (!string.IsNullOrEmpty(lastConnectionString) && !string.IsNullOrEmpty(lastDatabaseName))
            {
                SetStatus(string.Format("已加载上次连接配置: {0} (时间: {1})", 
                    GetConnectionDisplayName(), lastConnectionTime.ToString("yyyy-MM-dd HH:mm:ss")), Color.Blue);
            }
        }
    }
    catch (Exception ex)
    {
        SetStatus(string.Format("加载连接参数配置失败: {0}", ex.Message), Color.Orange);
        lastConnectionString = string.Empty;
        lastDatabaseName = string.Empty;
        lastConnectionTime = DateTime.MinValue;
    }
}
```

### 3. ShowAutoReconnectPrompt - 显示自动重连提示
```csharp
private void ShowAutoReconnectPrompt()
{
    try
    {
        // 只有在有上次连接参数且连接时间在24小时内时才提示
        if (!string.IsNullOrEmpty(lastConnectionString) && 
            !string.IsNullOrEmpty(lastDatabaseName) && 
            lastConnectionTime != DateTime.MinValue &&
            (DateTime.Now - lastConnectionTime).TotalHours <= 24)
        {
            // 延迟显示提示，避免在窗口初始化时显示
            this.Load += (sender, e) =>
            {
                var result = MessageBox.Show(
                    string.Format("检测到上次连接记录:\n{0}\n连接时间: {1}\n\n是否要重新连接到上次的数据库？", 
                        GetConnectionDisplayName(), 
                        lastConnectionTime.ToString("yyyy-MM-dd HH:mm:ss")),
                    "自动重连",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Question);
                    
                if (result == DialogResult.Yes)
                {
                    ReconnectToLastDatabase();
                }
            };
        }
    }
    catch (Exception ex)
    {
        SetStatus(string.Format("显示自动重连提示失败: {0}", ex.Message), Color.Orange);
    }
}
```

### 4. GetConnectionDisplayName - 获取安全的连接显示名称
```csharp
private string GetConnectionDisplayName()
{
    if (string.IsNullOrEmpty(lastConnectionString) || string.IsNullOrEmpty(lastDatabaseName))
        return "无";
        
    try
    {
        // 从连接字符串中提取主机和端口信息，隐藏用户名密码
        var uri = new Uri(lastConnectionString.Split('?')[0]); // 去掉查询参数
        string host = uri.Host;
        int port = uri.Port;
        return string.Format("{0}:{1}/{2}", host, port, lastDatabaseName);
    }
    catch
    {
        return string.Format("数据库: {0}", lastDatabaseName);
    }
}
```

### 5. ManualReconnectToLastDatabase - 手动重连功能
```csharp
public void ManualReconnectToLastDatabase()
{
    try
    {
        if (!string.IsNullOrEmpty(lastConnectionString) && !string.IsNullOrEmpty(lastDatabaseName))
        {
            var result = MessageBox.Show(
                string.Format("确认要重新连接到:\n{0}\n连接时间: {1}",
                    GetConnectionDisplayName(),
                    lastConnectionTime.ToString("yyyy-MM-dd HH:mm:ss")),
                "确认重连",
                MessageBoxButtons.YesNo,
                MessageBoxIcon.Question);
                
            if (result == DialogResult.Yes)
            {
                // 先断开当前连接
                DisconnectFromMongoDB();
                // 重新连接
                ReconnectToLastDatabase();
            }
        }
        else
        {
            MessageBox.Show("没有找到上次连接的参数记录", "提示", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }
    }
    catch (Exception ex)
    {
        MessageBox.Show(string.Format("手动重连失败: {0}", ex.Message), "错误", MessageBoxButtons.OK, MessageBoxIcon.Error);
    }
}
```

## 配置文件管理

### 1. 配置文件位置
- **Windows**: `%APPDATA%\MongoCompass\last_connection.ini`
- **路径示例**: `C:\Users\{Username}\AppData\Roaming\MongoCompass\last_connection.ini`

### 2. 配置文件格式
```ini
[LastConnection]
ConnectionString=mongodb://username:password@localhost:27017/mydb?authMechanism=SCRAM-SHA-1&authSource=admin&directConnection=true&serverSelectionTimeoutMS=15000&connectTimeoutMS=15000&socketTimeoutMS=30000&maxIdleTimeMS=30000&maxPoolSize=10&minPoolSize=1
DatabaseName=mydb
ConnectionTime=2024-01-15 14:30:25
```

### 3. 配置文件特点
- **INI格式**: 使用标准的INI文件格式，易于阅读和编辑
- **UTF-8编码**: 支持中文和特殊字符
- **自动创建**: 首次连接时自动创建配置目录和文件
- **安全存储**: 存储在用户专用目录，其他用户无法访问

## 用户界面增强

### 1. 工具栏新增按钮
- **按钮名称**: "重新连接"
- **位置**: 位于"连接配置"按钮右侧
- **工具提示**: "使用上次连接参数重新连接"
- **功能**: 点击后显示确认对话框，确认后重连到上次的数据库

### 2. 状态栏信息显示
- **加载时**: 显示蓝色信息"已加载上次连接配置: host:port/database (时间: yyyy-MM-dd HH:mm:ss)"
- **保存时**: 显示绿色信息"已保存连接参数配置: host:port/database"
- **重连时**: 显示蓝色信息"正在使用上次连接参数重新连接..."
- **错误时**: 显示橙色或红色错误信息

### 3. 对话框设计
- **自动重连提示**: 显示连接详情和时间，询问是否重连
- **手动重连确认**: 显示连接目标和上次连接时间，确认后执行
- **信息提示**: 当没有连接记录时，友好地提示用户

## 工作流程

### 1. 首次使用
1. 用户通过"连接配置"建立数据库连接
2. 连接成功后，系统自动保存连接参数
3. 连接信息存储到配置文件

### 2. 再次启动应用
1. 应用启动时自动加载上次连接参数
2. 如果连接记录在24小时内，显示自动重连提示
3. 用户选择是否自动重连

### 3. 手动重连
1. 用户点击工具栏"重新连接"按钮
2. 显示连接确认对话框
3. 用户确认后，先断开当前连接，再重新连接

### 4. 连接管理
1. 每次成功连接都会更新配置文件
2. 支持清除连接记录（通过ClearLastConnectionParams方法）
3. 异常情况下自动重置连接参数

## 安全性和稳定性

### 1. 数据安全
- **敏感信息保护**: 连接字符串完整保存，但显示时隐藏用户名密码
- **文件权限**: 配置文件存储在用户专用目录
- **编码安全**: 使用UTF-8编码，避免字符编码问题

### 2. 错误处理
- **文件操作异常**: 捕获文件读写权限问题
- **连接异常**: 处理网络和数据库连接错误
- **解析异常**: 处理配置文件格式错误
- **优雅降级**: 出错时不影响主要功能

### 3. 资源管理
- **连接清理**: 重连前自动断开当前连接
- **内存管理**: 及时释放不需要的资源
- **线程安全**: 避免并发访问配置文件

## 扩展功能建议

### 1. 多连接管理
- 支持保存多个连接配置
- 提供连接历史记录
- 支持连接配置的导入导出

### 2. 连接优化
- 自动检测网络状态
- 连接失败时的重试机制
- 连接池状态监控

### 3. 用户体验增强
- 连接成功/失败的声音提示
- 连接状态的图标指示
- 快捷键支持

## 总结

连接参数记忆功能提供了：

1. **便捷性**: 自动保存和加载连接参数，减少重复配置
2. **智能性**: 24小时内的连接记录自动提示重连
3. **安全性**: 隐藏敏感信息，安全存储配置
4. **稳定性**: 完善的错误处理和资源管理
5. **友好性**: 清晰的状态反馈和用户提示

这个功能特别适合需要频繁连接同一数据库的开发者和管理员，可以显著提升工作效率和用户体验。通过工具栏的"重新连接"按钮，用户可以随时快速重连到上次使用的数据库，无需重新输入连接参数。