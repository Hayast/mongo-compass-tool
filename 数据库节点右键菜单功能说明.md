# 数据库节点右键菜单功能说明

## 功能概述

在CompassForm中新增了数据库节点的右键菜单功能，当用户右键点击数据库节点时，会弹出包含"新建集合"和"关闭数据库连接"选项的菜单。

## 主要功能

### 1. 动态右键菜单
- **智能识别**: 根据点击的节点类型自动显示不同的右键菜单
- **数据库节点**: 显示"新建集合"和"关闭数据库连接"选项
- **集合节点**: 显示原有的集合管理选项（显示索引、创建索引、清空、复制、删除、导出、导入）
- **索引节点**: 显示索引管理选项（查看详情、删除索引）

### 2. 新建集合功能
- **操作位置**: 右键点击数据库节点 → "新建集合"
- **功能说明**:
  - 弹出输入框让用户输入新集合名称
  - 自动验证集合名称格式
  - 检查集合是否已存在
  - 创建新集合并刷新列表

### 3. 关闭数据库连接功能
- **操作位置**: 右键点击数据库节点 → "关闭数据库连接"
- **功能说明**:
  - 确认对话框防止误操作
  - 自动关闭相关的Tab页面
  - 从连接池中移除数据库
  - 从树形控件中移除数据库节点

## 技术实现

### 1. 右键菜单重构
```csharp
// 原来的静态菜单改为动态创建
private void InitializeContextMenu()
{
    // 绑定右键菜单事件到树形控件
    treeViewCollections.MouseClick += TreeViewCollections_MouseClick;
}
```

### 2. 节点类型识别
```csharp
private ContextMenuStrip CreateContextMenuForNode(TreeNode node)
{
    if (node.Tag != null)
    {
        string tag = node.Tag.ToString();
        
        if (tag.StartsWith("database:"))
        {
            // 数据库节点的右键菜单
            CreateDatabaseContextMenu(contextMenu, node);
        }
        else if (tag.StartsWith("collection:"))
        {
            // 集合节点的右键菜单
            CreateCollectionContextMenu(contextMenu, node);
        }
        else if (tag.StartsWith("index:"))
        {
            // 索引节点的右键菜单
            CreateIndexContextMenu(node);
        }
    }
}
```

### 3. 数据库节点菜单
```csharp
private void CreateDatabaseContextMenu(ContextMenuStrip contextMenu, TreeNode dbNode)
{
    string databaseName = dbNode.Text;
    
    // 新建集合菜单项
    ToolStripMenuItem menuItemNewCollection = new ToolStripMenuItem("新建集合");
    menuItemNewCollection.Click += (s, e) => CreateNewCollection(databaseName);
    contextMenu.Items.Add(menuItemNewCollection);
    
    // 添加分隔符
    contextMenu.Items.Add(new ToolStripSeparator());
    
    // 关闭数据库连接菜单项
    ToolStripMenuItem menuItemCloseConnection = new ToolStripMenuItem("关闭数据库连接");
    menuItemCloseConnection.Click += (s, e) => CloseDatabaseConnection(databaseName);
    contextMenu.Items.Add(menuItemCloseConnection);
}
```

## 核心方法

### 1. CreateNewCollection - 新建集合
- **功能**: 创建新的MongoDB集合
- **验证**: 检查集合名称格式和重复性
- **实现**: 通过插入临时文档创建集合，然后删除文档
- **反馈**: 成功提示和状态栏更新

### 2. CloseDatabaseConnection - 关闭数据库连接
- **功能**: 安全关闭数据库连接
- **清理**: 关闭相关Tab、移除连接、更新UI
- **确认**: 防止误操作的确认对话框

### 3. IsValidCollectionName - 验证集合名称
- **规则**: 符合MongoDB集合命名规范
- **检查**: 不能为空、不能以"system."开头、不能包含特殊字符

## 使用流程

### 新建集合
1. 右键点击数据库节点
2. 选择"新建集合"
3. 在弹出的输入框中输入集合名称
4. 点击确定创建集合
5. 系统自动刷新集合列表

### 关闭数据库连接
1. 右键点击数据库节点
2. 选择"关闭数据库连接"
3. 在确认对话框中点击"是"
4. 系统自动关闭相关Tab和连接

## 安全特性

### 1. 输入验证
- 集合名称格式验证
- 重复集合检查
- 特殊字符过滤

### 2. 操作确认
- 关闭连接前的确认对话框
- 防止误操作的提示信息

### 3. 错误处理
- 完整的异常捕获和处理
- 用户友好的错误提示
- 状态栏错误信息显示

## 用户体验

### 1. 直观的操作
- 右键菜单操作简单直观
- 清晰的菜单项分类
- 合理的分隔符使用

### 2. 即时反馈
- 操作成功/失败的明确提示
- 状态栏实时更新
- 自动刷新相关列表

### 3. 一致性
- 与其他右键菜单保持一致的样式
- 统一的字体和颜色主题
- 相同的交互模式

## 扩展性

代码设计具有良好的扩展性：
- 可以轻松添加新的数据库级操作
- 可以扩展节点类型识别逻辑
- 可以添加更多的验证规则
- 可以集成更多的数据库管理功能

## 注意事项

1. **权限要求**: 需要数据库的创建集合权限
2. **连接状态**: 只能对已连接的数据库进行操作
3. **数据安全**: 关闭连接会丢失未保存的数据
4. **命名规范**: 集合名称必须符合MongoDB规范

## 总结

新增的数据库节点右键菜单功能提供了：
1. **便捷的集合管理**: 快速创建新集合
2. **灵活的连接控制**: 按需关闭数据库连接
3. **智能的菜单系统**: 根据节点类型动态显示菜单
4. **安全的操作机制**: 完善的验证和确认机制

这些功能大大提升了MongoDB数据库管理的便利性和安全性。 