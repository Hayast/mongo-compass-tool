# 导入功能修正说明

## 修正内容

根据用户要求，修正了"导入目录数据"功能，现在只导入.bson文件集合，不再导入.metadata.json文件。

## 具体修改

### 1. ShowImportConfirmDialog方法修改

**修改前**:
```csharp
// 扫描目录中的文件
var jsonFiles = Directory.GetFiles(databasePath, "*.json", SearchOption.TopDirectoryOnly);
var bsonFiles = Directory.GetFiles(databasePath, "*.bson", SearchOption.TopDirectoryOnly);

if (jsonFiles.Length == 0 && bsonFiles.Length == 0)
{
    MessageBox.Show("在数据库目录中未找到任何 .json 或 .bson 文件", "提示", MessageBoxButtons.OK, MessageBoxIcon.Information);
    return false;
}
```

**修改后**:
```csharp
// 扫描目录中的文件，只处理.bson文件，排除.metadata.json文件
var allJsonFiles = Directory.GetFiles(databasePath, "*.json", SearchOption.TopDirectoryOnly);
var jsonFiles = allJsonFiles.Where(f => !Path.GetFileName(f).EndsWith(".metadata.json", StringComparison.OrdinalIgnoreCase)).ToArray();
var bsonFiles = Directory.GetFiles(databasePath, "*.bson", SearchOption.TopDirectoryOnly);

if (jsonFiles.Length == 0 && bsonFiles.Length == 0)
{
    MessageBox.Show("在数据库目录中未找到任何可导入的文件\n(.bson文件或非.metadata.json文件)", "提示", MessageBoxButtons.OK, MessageBoxIcon.Information);
    return false;
}
```

### 2. ImportDataFromDirectory方法修改

**修改前**:
```csharp
var database = connectedDatabases[databaseName];
var jsonFiles = Directory.GetFiles(databasePath, "*.json", SearchOption.TopDirectoryOnly);
var bsonFiles = Directory.GetFiles(databasePath, "*.bson", SearchOption.TopDirectoryOnly);

int totalFiles = jsonFiles.Length + bsonFiles.Length;
```

**修改后**:
```csharp
var database = connectedDatabases[databaseName];
// 过滤掉.metadata.json文件，只处理.bson文件和普通.json文件
var allJsonFiles = Directory.GetFiles(databasePath, "*.json", SearchOption.TopDirectoryOnly);
var jsonFiles = allJsonFiles.Where(f => !Path.GetFileName(f).EndsWith(".metadata.json", StringComparison.OrdinalIgnoreCase)).ToArray();
var bsonFiles = Directory.GetFiles(databasePath, "*.bson", SearchOption.TopDirectoryOnly);

int totalFiles = jsonFiles.Length + bsonFiles.Length;
```

## 修正原因

### 1. .metadata.json文件的作用
- .metadata.json文件通常包含集合的元数据信息（如索引定义、选项等）
- 这些文件不包含实际的文档数据
- 导入这些文件会创建空的集合或导致错误

### 2. MongoDB导出工具行为
- 使用mongodump等工具导出时，会生成.bson文件（包含数据）和.metadata.json文件（包含元数据）
- .bson文件包含实际的文档数据
- .metadata.json文件包含集合的配置信息

## 影响范围

### 1. 文件过滤逻辑
- **包含**: 普通的.json文件（如users.json, products.json）
- **包含**: 所有.bson文件（如users.bson, products.bson）
- **排除**: 以.metadata.json结尾的文件（如users.metadata.json）

### 2. 目录结构示例

**修正前会导入的文件**:
```
database/
├── users.json          ✓ 导入
├── users.metadata.json  ✓ 导入 (错误)
├── products.bson        ✓ 导入
├── products.metadata.json ✓ 导入 (错误)
└── logs.json           ✓ 导入
```

**修正后会导入的文件**:
```
database/
├── users.json          ✓ 导入
├── users.metadata.json  ✗ 跳过
├── products.bson        ✓ 导入
├── products.metadata.json ✗ 跳过
└── logs.json           ✓ 导入
```

## 技术实现

### 1. 文件名过滤
```csharp
var allJsonFiles = Directory.GetFiles(databasePath, "*.json", SearchOption.TopDirectoryOnly);
var jsonFiles = allJsonFiles.Where(f => !Path.GetFileName(f).EndsWith(".metadata.json", StringComparison.OrdinalIgnoreCase)).ToArray();
```

### 2. 大小写不敏感匹配
- 使用`StringComparison.OrdinalIgnoreCase`确保大小写不敏感
- 支持.METADATA.JSON、.Metadata.json等各种大小写组合

### 3. 路径处理
- 使用`Path.GetFileName()`只比较文件名部分
- 避免路径中包含.metadata.json字符串的误判

## 用户体验改进

### 1. 更准确的文件识别
- 只导入包含实际数据的文件
- 避免导入元数据文件导致的错误

### 2. 更清晰的提示信息
- 修改了"未找到文件"的提示信息
- 明确说明支持的文件类型

### 3. 更可靠的导入过程
- 减少因导入元数据文件导致的错误
- 提高导入成功率

## 兼容性

### 1. 向后兼容
- 仍然支持普通的.json文件导入
- 仍然支持.bson文件导入
- 只是排除了.metadata.json文件

### 2. mongodump兼容
- 完美兼容mongodump导出的目录结构
- 自动跳过元数据文件，只导入数据文件

## 测试场景

### 1. 标准mongodump导出
```
backup/
└── mydb/
    ├── users.bson
    ├── users.metadata.json    (跳过)
    ├── products.bson
    └── products.metadata.json (跳过)
```

### 2. 混合文件类型
```
backup/
└── mydb/
    ├── users.json             (导入)
    ├── users.metadata.json    (跳过)
    ├── products.bson          (导入)
    ├── logs.json              (导入)
    └── system.metadata.json   (跳过)
```

## 总结

这次修正主要解决了以下问题：
1. **数据准确性**: 只导入包含实际数据的文件
2. **错误预防**: 避免导入元数据文件导致的错误
3. **兼容性提升**: 更好地兼容MongoDB标准导出格式
4. **用户体验**: 更清晰的提示和更可靠的导入过程

修正后的功能更加智能和可靠，能够正确识别和处理MongoDB标准的备份文件结构。