# 导入目录数据功能说明

## 功能概述

在CompassForm中新增了"导入目录数据"功能，允许用户通过数据库节点的右键菜单批量导入目录中的数据文件到对应的MongoDB集合中。

## 主要功能

### 1. 导入目录数据菜单项
- **操作位置**: 右键点击数据库节点 → "导入目录数据"
- **功能说明**: 批量导入目录中的数据文件到数据库

### 2. 目录结构要求
```
选择的根目录/
└── {数据库名称}/
    ├── collection1.json
    ├── collection2.json
    ├── collection3.bson
    └── collection4.bson
```

### 3. 支持的文件格式
- **JSON文件** (*.json): 每行一个JSON文档
- **BSON文件** (*.bson): MongoDB二进制格式文件

## 使用流程

### 1. 选择导入目录
1. 右键点击数据库节点
2. 选择"导入目录数据"
3. 在文件夹选择对话框中选择包含数据文件的根目录
4. 系统会自动查找与数据库同名的子目录

### 2. 确认导入信息
- 显示将要导入的文件列表
- 显示目标数据库名称
- 警告提示：如果集合已存在将先删除后导入

### 3. 执行导入操作
- 自动处理JSON和BSON文件
- 实时显示导入进度
- 自动刷新集合列表

## 技术实现

### 1. ImportDirectoryData方法
```csharp
private void ImportDirectoryData(string databaseName)
{
    // 显示文件夹选择对话框
    using (FolderBrowserDialog folderDialog = new FolderBrowserDialog())
    {
        // 验证数据库目录是否存在
        string databasePath = Path.Combine(rootPath, databaseName);
        if (!Directory.Exists(databasePath))
        {
            // 错误提示
            return;
        }
        
        // 显示导入确认对话框
        if (ShowImportConfirmDialog(databaseName, databasePath))
        {
            ImportDataFromDirectory(databaseName, databasePath);
        }
    }
}
```

### 2. ShowImportConfirmDialog方法
- 扫描目录中的JSON和BSON文件
- 创建美观的确认对话框
- 显示文件列表和警告信息
- 返回用户确认结果

### 3. ImportDataFromDirectory方法
- 处理JSON文件：逐行解析JSON文档
- 处理BSON文件：反序列化BSON文档
- 集合存在检查：先删除后创建
- 批量插入：使用InsertMany提高性能
- 进度显示：实时更新状态栏

## 核心特性

### 1. 智能文件识别
- 自动识别JSON和BSON文件
- 根据文件名创建对应的集合
- 支持UTF-8编码的JSON文件

### 2. 集合覆盖策略
- 检查集合是否已存在
- 存在则先删除后导入
- 确保数据的完整性和一致性

### 3. 错误处理机制
- 文件解析错误处理
- 数据库操作异常捕获
- 详细的错误信息提示
- 部分失败不影响其他文件

### 4. 用户友好界面
- 美观的确认对话框
- 实时进度显示
- 详细的结果统计
- 清晰的状态栏信息

## 安全特性

### 1. 目录验证
- 验证根目录是否存在
- 验证数据库子目录是否存在
- 验证文件格式是否支持

### 2. 数据保护
- 导入前显示确认对话框
- 明确警告集合覆盖操作
- 支持用户取消操作

### 3. 事务安全
- 单个文件导入失败不影响其他文件
- 详细的错误日志记录
- 操作结果统计和反馈

## 性能优化

### 1. 批量操作
- 使用InsertMany批量插入文档
- 减少数据库连接次数
- 提高导入效率

### 2. 内存管理
- 逐文件处理，避免内存溢出
- 及时释放文件句柄
- 优化大文件读取

### 3. 进度反馈
- 实时更新导入进度
- 显示当前处理的文件
- 提供操作状态反馈

## 使用示例

### 目录结构示例
```
D:\MongoBackup\
└── myDatabase\
    ├── users.json          (用户数据)
    ├── products.json       (产品数据)
    ├── orders.bson         (订单数据)
    └── logs.json           (日志数据)
```

### JSON文件格式示例
```json
{"_id": "507f1f77bcf86cd799439011", "name": "John", "age": 30}
{"_id": "507f1f77bcf86cd799439012", "name": "Jane", "age": 25}
{"_id": "507f1f77bcf86cd799439013", "name": "Bob", "age": 35}
```

### 操作流程示例
1. 右键点击"myDatabase"数据库节点
2. 选择"导入目录数据"
3. 选择"D:\MongoBackup\"目录
4. 确认导入4个文件
5. 等待导入完成
6. 查看导入结果统计

## 错误处理

### 1. 常见错误类型
- **目录不存在**: 选择的目录中没有对应的数据库子目录
- **文件格式错误**: JSON格式不正确或BSON文件损坏
- **权限不足**: 没有读取文件或写入数据库的权限
- **网络问题**: 数据库连接中断

### 2. 错误处理策略
- 显示具体的错误信息
- 记录错误到状态栏
- 部分失败继续处理其他文件
- 提供重试建议

## 扩展性

### 1. 支持更多文件格式
- 可以扩展支持CSV文件
- 可以添加XML文件支持
- 可以支持压缩文件格式

### 2. 高级导入选项
- 可以添加数据转换功能
- 可以支持字段映射
- 可以添加数据验证规则

### 3. 批量操作增强
- 可以支持多数据库导入
- 可以添加导入计划任务
- 可以支持增量导入模式

## 注意事项

1. **数据备份**: 导入前建议备份现有数据
2. **文件编码**: JSON文件需要使用UTF-8编码
3. **文件大小**: 大文件导入可能需要较长时间
4. **权限要求**: 需要数据库的写入权限
5. **网络稳定**: 确保数据库连接稳定

## 总结

"导入目录数据"功能提供了：
1. **便捷的批量导入**: 一次操作导入多个集合
2. **智能的文件识别**: 自动识别和处理不同格式
3. **安全的覆盖机制**: 先删除后导入确保数据一致性
4. **友好的用户界面**: 清晰的确认和进度显示
5. **完善的错误处理**: 详细的错误信息和部分失败处理

这个功能大大提升了MongoDB数据管理的效率，特别适合数据迁移和批量导入场景。