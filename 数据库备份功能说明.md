# 数据库备份功能说明

## 功能概述

根据用户要求，在左边树的数据库节点右键菜单中增加了"备份数据库"选项。该功能会将指定数据库的所有集合导出为.bson文件，并将索引等信息导出为.metadata.json文件，备份到执行目录下的`backup\数据库名称`目录中。

## 功能特点

### 1. 完整的数据库备份
- **数据备份**: 导出所有集合的数据为.bson文件
- **索引备份**: 导出所有集合的索引信息为.metadata.json文件
- **统计信息**: 包含集合的文档数量、大小等统计信息

### 2. 自动目录管理
- **自动创建**: 自动创建备份目录结构
- **目录结构**: `backup\数据库名称\`
- **文件命名**: 集合名.bson 和 集合名.metadata.json

### 3. 进度反馈
- **实时状态**: 显示当前备份进度
- **详细统计**: 显示成功和失败的集合数量
- **错误处理**: 单个集合失败不影响其他集合的备份

## 实现原理

### 1. 菜单集成

**文件位置**: `CompassForm.cs` - `CreateDatabaseContextMenu`方法

**新增菜单项**:
```csharp
// 备份数据库菜单项
ToolStripMenuItem menuItemBackupDatabase = new ToolStripMenuItem("备份数据库");
menuItemBackupDatabase.Click += (s, e) => BackupDatabase(databaseName);
contextMenu.Items.Add(menuItemBackupDatabase);
```

### 2. 备份流程

**主要方法**: `BackupDatabase(string databaseName)`

**备份步骤**:
1. 创建备份目录
2. 获取数据库中的所有集合
3. 遍历每个集合进行备份
4. 导出数据为.bson文件
5. 导出元数据为.metadata.json文件
6. 显示备份结果统计

### 3. 数据导出

**BSON数据导出**: `ExportCollectionToBson`方法
```csharp
private void ExportCollectionToBson(IMongoCollection<BsonDocument> collection, string filePath)
{
    using (FileStream fs = new FileStream(filePath, FileMode.Create, FileAccess.Write))
    {
        var documents = collection.Find(new BsonDocument()).ToList();
        foreach (var doc in documents)
        {
            MongoDB.Bson.Serialization.BsonSerializer.Serialize(fs, doc);
        }
    }
}
```

**元数据导出**: `ExportCollectionMetadata`方法
```csharp
private void ExportCollectionMetadata(IMongoCollection<BsonDocument> collection, string filePath)
{
    // 获取索引信息
    var indexes = collection.Indexes.List().ToList();
    
    // 创建元数据文档
    var metadata = new BsonDocument();
    metadata.Add("indexes", new BsonArray(indexes));
    
    // 获取统计信息
    var stats = collection.Database.RunCommand<BsonDocument>(
        new BsonDocument("collStats", collection.CollectionNamespace.CollectionName));
    
    // 添加统计信息到元数据
    if (stats.Contains("count")) metadata.Add("count", stats["count"]);
    if (stats.Contains("size")) metadata.Add("size", stats["size"]);
    if (stats.Contains("avgObjSize")) metadata.Add("avgObjSize", stats["avgObjSize"]);
    
    // 写入JSON文件
    string jsonContent = metadata.ToJson(new MongoDB.Bson.IO.JsonWriterSettings { Indent = true });
    File.WriteAllText(filePath, jsonContent, Encoding.UTF8);
}
```

## 备份文件结构

### 1. 目录结构
```
backup/
└── 数据库名称/
    ├── 集合1.bson
    ├── 集合1.metadata.json
    ├── 集合2.bson
    ├── 集合2.metadata.json
    └── ...
```

### 2. BSON文件格式
- **文件扩展名**: .bson
- **内容**: MongoDB BSON格式的文档数据
- **用途**: 包含集合的所有文档数据
- **兼容性**: 与MongoDB官方工具兼容

### 3. 元数据文件格式
- **文件扩展名**: .metadata.json
- **内容**: JSON格式的集合元数据
- **包含信息**:
  - 索引定义和配置
  - 集合统计信息（文档数量、大小等）
  - 索引选项和属性

**元数据文件示例**:
```json
{
  "indexes": [
    {
      "v": 2,
      "key": {
        "_id": 1
      },
      "name": "_id_",
      "unique": true
    },
    {
      "v": 2,
      "key": {
        "field1": 1
      },
      "name": "idx_field1",
      "background": true
    }
  ],
  "count": 1000,
  "size": 1024000,
  "avgObjSize": 1024
}
```

## 使用流程

### 1. 触发备份
1. 右键点击数据库节点
2. 选择"备份数据库"菜单项
3. 系统开始自动备份过程

### 2. 备份过程
1. **目录创建**: 自动创建`backup\数据库名称`目录
2. **集合扫描**: 获取数据库中的所有集合
3. **数据导出**: 逐个导出集合数据为.bson文件
4. **元数据导出**: 导出索引和统计信息为.metadata.json文件
5. **进度显示**: 实时显示备份进度和状态

### 3. 完成反馈
- **成功统计**: 显示成功备份的集合数量
- **失败统计**: 显示备份失败的集合数量
- **位置信息**: 显示备份文件的存储位置
- **详细结果**: 弹出对话框显示完整的备份结果

## 错误处理

### 1. 目录权限错误
- **处理方式**: 显示错误信息，停止备份
- **用户提示**: 检查目录权限和磁盘空间

### 2. 集合访问错误
- **处理方式**: 跳过失败的集合，继续备份其他集合
- **状态反馈**: 在状态栏显示具体错误信息

### 3. 统计信息获取失败
- **处理方式**: 只导出索引信息，跳过统计信息
- **降级处理**: 确保基本的索引信息能够导出

### 4. 网络连接问题
- **处理方式**: 捕获异常并显示友好错误信息
- **用户指导**: 提示检查网络连接和数据库状态

## 性能优化

### 1. 批量处理
- **内存管理**: 逐个处理集合，避免内存溢出
- **进度反馈**: 实时显示处理进度

### 2. 错误隔离
- **独立处理**: 单个集合失败不影响其他集合
- **继续执行**: 即使部分失败也能完成其他集合的备份

### 3. 文件操作优化
- **流式写入**: 使用FileStream进行高效文件写入
- **资源管理**: 正确释放文件流资源

## 与现有功能的集成

### 1. 与导入功能的兼容
- **文件格式**: 导出的.bson和.metadata.json文件与导入功能完全兼容
- **目录结构**: 支持使用"导入目录数据"功能恢复备份

### 2. 与索引管理的集成
- **索引信息**: 备份包含完整的索引定义
- **恢复支持**: 可以通过索引导入功能恢复索引配置

### 3. 与现有备份功能的区别
- **范围不同**: 现有备份功能针对单个集合，新功能备份整个数据库
- **格式统一**: 使用相同的文件格式，确保兼容性

## 使用场景

### 1. 数据库迁移
- **完整备份**: 备份整个数据库用于迁移
- **格式兼容**: 与MongoDB官方工具兼容

### 2. 数据备份
- **定期备份**: 定期备份重要数据库
- **灾难恢复**: 用于数据恢复和重建

### 3. 开发测试
- **测试数据**: 备份测试数据库用于环境重建
- **数据共享**: 在不同环境间共享数据库结构

## 扩展性

### 1. 功能扩展
- **压缩支持**: 可以添加文件压缩功能
- **增量备份**: 支持增量备份机制
- **定时备份**: 支持定时自动备份

### 2. 配置选项
- **备份路径**: 可配置备份目录路径
- **文件格式**: 支持不同的导出格式
- **过滤选项**: 支持选择性备份集合

## 总结

数据库备份功能实现了：

1. **完整备份**: 备份数据库的所有集合和索引信息
2. **标准格式**: 使用MongoDB标准的.bson和.metadata.json格式
3. **用户友好**: 简单的右键菜单操作，详细的进度反馈
4. **错误处理**: 完善的错误处理和用户提示
5. **兼容性强**: 与现有导入功能和MongoDB官方工具兼容

这个功能为用户提供了便捷的数据库备份解决方案，支持完整的数据和索引备份，为数据安全和迁移提供了强有力的支持。 