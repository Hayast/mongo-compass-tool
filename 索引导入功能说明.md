# 索引导入功能说明

## 功能概述

扩展了"导入目录数据"功能，现在能够自动分析和导入`.metadata.json`文件中的索引配置信息。在导入集合数据的同时，自动创建相应的索引，完整恢复MongoDB集合的结构和性能优化配置。

## 主要功能

### 1. 自动索引检测
- **metadata文件识别**: 自动检测与集合同名的`.metadata.json`文件
- **索引信息解析**: 解析metadata文件中的索引定义
- **智能跳过**: 自动跳过MongoDB默认的`_id_`索引
- **错误容忍**: 单个索引创建失败不影响其他索引的创建

### 2. 完整索引支持
- **基本索引**: 支持升序(1)、降序(-1)索引
- **地理索引**: 支持2D(2)和2DSphere(3)地理空间索引
- **复合索引**: 支持多字段组合索引
- **特殊索引**: 支持唯一索引、稀疏索引、TTL索引等

### 3. 索引选项支持
- **唯一性**: `unique`选项
- **稀疏性**: `sparse`选项  
- **后台创建**: `background`选项
- **TTL过期**: `expireAfterSeconds`选项
- **部分索引**: `partialFilterExpression`过滤器
- **自定义名称**: 支持自定义索引名称

### 4. 用户界面增强
- **文件列表显示**: 确认对话框中显示数据文件和索引配置文件
- **图标区分**: 📄 数据文件，🔧 索引配置文件
- **导入提示**: 明确提示将同时导入数据和索引配置
- **详细状态**: 实时显示索引创建进度和结果

## 技术实现

### 1. 核心方法
```csharp
private void ImportCollectionIndexes(string databasePath, string collectionName, IMongoCollection<BsonDocument> collection)
```

### 2. metadata.json文件结构
```json
{
  "indexes": [
    {
      "v": 2,
      "key": {
        "fieldName": 1,
        "anotherField": -1
      },
      "name": "idx_fieldName_1_anotherField_-1",
      "unique": true,
      "sparse": false,
      "background": true,
      "expireAfterSeconds": 3600,
      "partialFilterExpression": {
        "status": "active"
      }
    }
  ]
}
```

### 3. 索引类型映射
- **1**: 升序索引 (`Ascending`)
- **-1**: 降序索引 (`Descending`)
- **2**: 2D地理索引 (`Geo2D`)
- **3**: 2DSphere地理索引 (`Geo2DSphere`)

## 详细实现逻辑

### 1. 文件检测和解析
```csharp
string metadataFilePath = Path.Combine(databasePath, collectionName + ".metadata.json");

if (!File.Exists(metadataFilePath))
{
    SetStatus(string.Format("未找到集合 {0} 的metadata.json文件，跳过索引导入", collectionName), Color.Orange);
    return;
}

// 读取并解析metadata.json文件
string metadataContent = File.ReadAllText(metadataFilePath, Encoding.UTF8);
var metadataDoc = BsonDocument.Parse(metadataContent);
```

### 2. 索引定义构建
```csharp
// 构建索引键定义
var indexKeysBuilder = Builders<BsonDocument>.IndexKeys;
IndexKeysDefinition<BsonDocument> indexKeys = null;

foreach (var element in keyDoc.Elements)
{
    var fieldName = element.Name;
    var direction = element.Value.AsInt32;
    
    IndexKeysDefinition<BsonDocument> fieldIndex;
    if (direction == 1)
        fieldIndex = indexKeysBuilder.Ascending(fieldName);
    else if (direction == -1)
        fieldIndex = indexKeysBuilder.Descending(fieldName);
    else if (direction == 2)
        fieldIndex = indexKeysBuilder.Geo2D(fieldName);
    else if (direction == 3)
        fieldIndex = indexKeysBuilder.Geo2DSphere(fieldName);
    else
        fieldIndex = indexKeysBuilder.Ascending(fieldName); // 默认升序
    
    // 组合多个字段
    if (isFirst)
    {
        indexKeys = fieldIndex;
        isFirst = false;
    }
    else
    {
        indexKeys = indexKeys.Combine(fieldIndex);
    }
}
```

### 3. 索引选项配置
```csharp
var createIndexOptions = new CreateIndexOptions();

// 设置索引名称
if (indexDoc.Contains("name") && indexDoc["name"].IsString)
{
    createIndexOptions.Name = indexDoc["name"].AsString;
}

// 设置唯一性
if (indexDoc.Contains("unique") && indexDoc["unique"].IsBoolean)
{
    createIndexOptions.Unique = indexDoc["unique"].AsBoolean;
}

// 设置稀疏索引
if (indexDoc.Contains("sparse") && indexDoc["sparse"].IsBoolean)
{
    createIndexOptions.Sparse = indexDoc["sparse"].AsBoolean;
}

// 设置后台创建
if (indexDoc.Contains("background") && indexDoc["background"].IsBoolean)
{
    createIndexOptions.Background = indexDoc["background"].AsBoolean;
}

// 设置TTL
if (indexDoc.Contains("expireAfterSeconds") && indexDoc["expireAfterSeconds"].IsNumeric)
{
    createIndexOptions.ExpireAfter = TimeSpan.FromSeconds(indexDoc["expireAfterSeconds"].AsDouble);
}

// 设置部分索引过滤器
if (indexDoc.Contains("partialFilterExpression") && indexDoc["partialFilterExpression"].IsBsonDocument)
{
    createIndexOptions.PartialFilterExpression = indexDoc["partialFilterExpression"].AsBsonDocument;
}
```

### 4. 索引创建和错误处理
```csharp
try
{
    // 创建索引模型
    var indexModel = new CreateIndexModel<BsonDocument>(indexKeys, createIndexOptions);
    
    // 创建索引
    collection.Indexes.CreateOne(indexModel);
    
    string indexName = createIndexOptions.Name ?? "未命名索引";
    SetStatus(string.Format("成功创建索引: {0} (集合: {1})", indexName, collectionName), Color.Green);
    createdCount++;
}
catch (Exception indexEx)
{
    string indexName = "未知索引";
    if (indexDoc.Contains("name") && indexDoc["name"].IsString)
    {
        indexName = indexDoc["name"].AsString;
    }
    SetStatus(string.Format("创建索引 {0} 失败: {1}", indexName, indexEx.Message), Color.Red);
    skippedCount++;
}
```

## 工作流程

### 1. 数据导入流程
1. **扫描文件**: 识别数据文件(.json/.bson)和metadata文件(.metadata.json)
2. **显示确认**: 在确认对话框中显示将要导入的文件列表
3. **导入数据**: 先导入集合数据
4. **导入索引**: 数据导入成功后，自动查找并导入索引配置

### 2. 索引导入流程
1. **检测metadata文件**: 查找与集合同名的.metadata.json文件
2. **解析索引定义**: 解析文件中的indexes数组
3. **跳过默认索引**: 自动跳过_id_索引
4. **创建自定义索引**: 逐个创建用户定义的索引
5. **报告结果**: 统计创建成功和失败的索引数量

### 3. 错误处理机制
1. **文件级错误**: metadata文件不存在或格式错误时跳过索引导入
2. **索引级错误**: 单个索引创建失败时继续处理其他索引
3. **详细日志**: 每个操作都有详细的状态反馈
4. **优雅降级**: 索引导入失败不影响数据导入的成功

## 用户界面改进

### 1. 确认对话框增强
- **文件分类显示**: 
  - 📄 数据文件 (.json/.bson)
  - 🔧 索引配置文件 (.metadata.json)
- **功能说明**: 明确提示将同时导入数据和索引配置信息
- **视觉区分**: 使用图标和颜色区分不同类型的文件

### 2. 状态信息增强
- **索引分析**: "正在分析 collection.metadata.json 中的索引信息..."
- **索引创建**: "成功创建索引: idx_name (集合: collection)"
- **统计信息**: "集合 collection 索引导入完成: 总计 3, 创建 2, 跳过 1"
- **颜色编码**: 
  - 🟢 绿色: 成功操作
  - 🟠 橙色: 警告信息
  - 🔴 红色: 错误信息
  - 🔵 蓝色: 进度信息

### 3. 错误信息优化
- **具体错误**: 显示具体的索引名称和错误原因
- **继续执行**: 单个索引失败不中断整个导入过程
- **最终统计**: 显示成功和失败的索引数量

## 支持的索引类型示例

### 1. 基本索引
```json
{
  "key": { "username": 1 },
  "name": "idx_username_1",
  "unique": true
}
```

### 2. 复合索引
```json
{
  "key": { "category": 1, "createdAt": -1 },
  "name": "idx_category_1_createdAt_-1"
}
```

### 3. TTL索引
```json
{
  "key": { "expireAt": 1 },
  "name": "idx_expireAt_1",
  "expireAfterSeconds": 3600
}
```

### 4. 地理空间索引
```json
{
  "key": { "location": "2dsphere" },
  "name": "idx_location_2dsphere"
}
```

### 5. 部分索引
```json
{
  "key": { "email": 1 },
  "name": "idx_email_1_partial",
  "partialFilterExpression": { "email": { "$exists": true } }
}
```

### 6. 稀疏索引
```json
{
  "key": { "phone": 1 },
  "name": "idx_phone_1",
  "sparse": true
}
```

## 兼容性和限制

### 1. 兼容性
- **MongoDB版本**: 支持MongoDB 3.0+的所有索引类型
- **导出工具**: 兼容`mongodump`导出的metadata.json格式
- **字符编码**: 支持UTF-8编码的metadata文件

### 2. 当前限制
- **文本索引**: 暂不支持全文索引(text index)
- **哈希索引**: 暂不支持哈希索引(hashed index)
- **通配符索引**: 暂不支持通配符索引(wildcard index)

### 3. 扩展性
- 代码结构支持轻松添加新的索引类型
- 错误处理机制确保向后兼容性
- 模块化设计便于功能扩展

## 性能考虑

### 1. 索引创建性能
- **后台创建**: 支持background选项，避免阻塞数据库操作
- **批量处理**: 逐个创建索引，避免内存压力
- **错误隔离**: 单个索引失败不影响其他索引

### 2. 导入性能优化
- **数据优先**: 先导入数据，再创建索引，提高插入性能
- **状态反馈**: 实时显示进度，提升用户体验
- **资源管理**: 及时释放文件句柄和内存资源

## 使用建议

### 1. 最佳实践
- **备份验证**: 导入前确认metadata.json文件的完整性
- **索引规划**: 大数据集建议使用background选项创建索引
- **错误监控**: 关注状态栏信息，及时处理索引创建错误

### 2. 故障排除
- **权限问题**: 确保数据库用户有创建索引的权限
- **内存不足**: 大索引创建时可能需要更多内存
- **重复索引**: 避免创建重复的索引定义

### 3. 维护建议
- **定期检查**: 导入后验证索引是否正确创建
- **性能监控**: 监控索引对查询性能的影响
- **清理无用索引**: 定期清理不再使用的索引

## 总结

索引导入功能提供了：

1. **完整性**: 同时导入数据和索引，完整恢复集合结构
2. **自动化**: 自动检测和解析metadata文件，无需手动操作
3. **容错性**: 完善的错误处理，单个索引失败不影响整体导入
4. **可视化**: 清晰的用户界面和状态反馈
5. **兼容性**: 支持mongodump标准格式，与现有工具兼容

这个功能特别适合：
- 数据库迁移场景
- 开发环境数据恢复
- 备份数据的完整还原
- 集合结构的批量复制

通过这个功能，用户可以一键完成数据和索引的完整导入，大大简化了MongoDB数据迁移和恢复的工作流程。