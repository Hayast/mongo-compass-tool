# ç´¢å¼•å¯¼å…¥åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

æ‰©å±•äº†"å¯¼å…¥ç›®å½•æ•°æ®"åŠŸèƒ½ï¼Œç°åœ¨èƒ½å¤Ÿè‡ªåŠ¨åˆ†æå’Œå¯¼å…¥`.metadata.json`æ–‡ä»¶ä¸­çš„ç´¢å¼•é…ç½®ä¿¡æ¯ã€‚åœ¨å¯¼å…¥é›†åˆæ•°æ®çš„åŒæ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºç›¸åº”çš„ç´¢å¼•ï¼Œå®Œæ•´æ¢å¤MongoDBé›†åˆçš„ç»“æ„å’Œæ€§èƒ½ä¼˜åŒ–é…ç½®ã€‚

## ä¸»è¦åŠŸèƒ½

### 1. è‡ªåŠ¨ç´¢å¼•æ£€æµ‹
- **metadataæ–‡ä»¶è¯†åˆ«**: è‡ªåŠ¨æ£€æµ‹ä¸é›†åˆåŒåçš„`.metadata.json`æ–‡ä»¶
- **ç´¢å¼•ä¿¡æ¯è§£æ**: è§£æmetadataæ–‡ä»¶ä¸­çš„ç´¢å¼•å®šä¹‰
- **æ™ºèƒ½è·³è¿‡**: è‡ªåŠ¨è·³è¿‡MongoDBé»˜è®¤çš„`_id_`ç´¢å¼•
- **é”™è¯¯å®¹å¿**: å•ä¸ªç´¢å¼•åˆ›å»ºå¤±è´¥ä¸å½±å“å…¶ä»–ç´¢å¼•çš„åˆ›å»º

### 2. å®Œæ•´ç´¢å¼•æ”¯æŒ
- **åŸºæœ¬ç´¢å¼•**: æ”¯æŒå‡åº(1)ã€é™åº(-1)ç´¢å¼•
- **åœ°ç†ç´¢å¼•**: æ”¯æŒ2D(2)å’Œ2DSphere(3)åœ°ç†ç©ºé—´ç´¢å¼•
- **å¤åˆç´¢å¼•**: æ”¯æŒå¤šå­—æ®µç»„åˆç´¢å¼•
- **ç‰¹æ®Šç´¢å¼•**: æ”¯æŒå”¯ä¸€ç´¢å¼•ã€ç¨€ç–ç´¢å¼•ã€TTLç´¢å¼•ç­‰

### 3. ç´¢å¼•é€‰é¡¹æ”¯æŒ
- **å”¯ä¸€æ€§**: `unique`é€‰é¡¹
- **ç¨€ç–æ€§**: `sparse`é€‰é¡¹  
- **åå°åˆ›å»º**: `background`é€‰é¡¹
- **TTLè¿‡æœŸ**: `expireAfterSeconds`é€‰é¡¹
- **éƒ¨åˆ†ç´¢å¼•**: `partialFilterExpression`è¿‡æ»¤å™¨
- **è‡ªå®šä¹‰åç§°**: æ”¯æŒè‡ªå®šä¹‰ç´¢å¼•åç§°

### 4. ç”¨æˆ·ç•Œé¢å¢å¼º
- **æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º**: ç¡®è®¤å¯¹è¯æ¡†ä¸­æ˜¾ç¤ºæ•°æ®æ–‡ä»¶å’Œç´¢å¼•é…ç½®æ–‡ä»¶
- **å›¾æ ‡åŒºåˆ†**: ğŸ“„ æ•°æ®æ–‡ä»¶ï¼ŒğŸ”§ ç´¢å¼•é…ç½®æ–‡ä»¶
- **å¯¼å…¥æç¤º**: æ˜ç¡®æç¤ºå°†åŒæ—¶å¯¼å…¥æ•°æ®å’Œç´¢å¼•é…ç½®
- **è¯¦ç»†çŠ¶æ€**: å®æ—¶æ˜¾ç¤ºç´¢å¼•åˆ›å»ºè¿›åº¦å’Œç»“æœ

## æŠ€æœ¯å®ç°

### 1. æ ¸å¿ƒæ–¹æ³•
```csharp
private void ImportCollectionIndexes(string databasePath, string collectionName, IMongoCollection<BsonDocument> collection)
```

### 2. metadata.jsonæ–‡ä»¶ç»“æ„
```json
{
  "indexes": [
    {
      "v": 2,
      "key": {
        "fieldName": 1,
        "anotherField": -1
      },
      "name": "idx_fieldName_1_anotherField_-1",
      "unique": true,
      "sparse": false,
      "background": true,
      "expireAfterSeconds": 3600,
      "partialFilterExpression": {
        "status": "active"
      }
    }
  ]
}
```

### 3. ç´¢å¼•ç±»å‹æ˜ å°„
- **1**: å‡åºç´¢å¼• (`Ascending`)
- **-1**: é™åºç´¢å¼• (`Descending`)
- **2**: 2Dåœ°ç†ç´¢å¼• (`Geo2D`)
- **3**: 2DSphereåœ°ç†ç´¢å¼• (`Geo2DSphere`)

## è¯¦ç»†å®ç°é€»è¾‘

### 1. æ–‡ä»¶æ£€æµ‹å’Œè§£æ
```csharp
string metadataFilePath = Path.Combine(databasePath, collectionName + ".metadata.json");

if (!File.Exists(metadataFilePath))
{
    SetStatus(string.Format("æœªæ‰¾åˆ°é›†åˆ {0} çš„metadata.jsonæ–‡ä»¶ï¼Œè·³è¿‡ç´¢å¼•å¯¼å…¥", collectionName), Color.Orange);
    return;
}

// è¯»å–å¹¶è§£æmetadata.jsonæ–‡ä»¶
string metadataContent = File.ReadAllText(metadataFilePath, Encoding.UTF8);
var metadataDoc = BsonDocument.Parse(metadataContent);
```

### 2. ç´¢å¼•å®šä¹‰æ„å»º
```csharp
// æ„å»ºç´¢å¼•é”®å®šä¹‰
var indexKeysBuilder = Builders<BsonDocument>.IndexKeys;
IndexKeysDefinition<BsonDocument> indexKeys = null;

foreach (var element in keyDoc.Elements)
{
    var fieldName = element.Name;
    var direction = element.Value.AsInt32;
    
    IndexKeysDefinition<BsonDocument> fieldIndex;
    if (direction == 1)
        fieldIndex = indexKeysBuilder.Ascending(fieldName);
    else if (direction == -1)
        fieldIndex = indexKeysBuilder.Descending(fieldName);
    else if (direction == 2)
        fieldIndex = indexKeysBuilder.Geo2D(fieldName);
    else if (direction == 3)
        fieldIndex = indexKeysBuilder.Geo2DSphere(fieldName);
    else
        fieldIndex = indexKeysBuilder.Ascending(fieldName); // é»˜è®¤å‡åº
    
    // ç»„åˆå¤šä¸ªå­—æ®µ
    if (isFirst)
    {
        indexKeys = fieldIndex;
        isFirst = false;
    }
    else
    {
        indexKeys = indexKeys.Combine(fieldIndex);
    }
}
```

### 3. ç´¢å¼•é€‰é¡¹é…ç½®
```csharp
var createIndexOptions = new CreateIndexOptions();

// è®¾ç½®ç´¢å¼•åç§°
if (indexDoc.Contains("name") && indexDoc["name"].IsString)
{
    createIndexOptions.Name = indexDoc["name"].AsString;
}

// è®¾ç½®å”¯ä¸€æ€§
if (indexDoc.Contains("unique") && indexDoc["unique"].IsBoolean)
{
    createIndexOptions.Unique = indexDoc["unique"].AsBoolean;
}

// è®¾ç½®ç¨€ç–ç´¢å¼•
if (indexDoc.Contains("sparse") && indexDoc["sparse"].IsBoolean)
{
    createIndexOptions.Sparse = indexDoc["sparse"].AsBoolean;
}

// è®¾ç½®åå°åˆ›å»º
if (indexDoc.Contains("background") && indexDoc["background"].IsBoolean)
{
    createIndexOptions.Background = indexDoc["background"].AsBoolean;
}

// è®¾ç½®TTL
if (indexDoc.Contains("expireAfterSeconds") && indexDoc["expireAfterSeconds"].IsNumeric)
{
    createIndexOptions.ExpireAfter = TimeSpan.FromSeconds(indexDoc["expireAfterSeconds"].AsDouble);
}

// è®¾ç½®éƒ¨åˆ†ç´¢å¼•è¿‡æ»¤å™¨
if (indexDoc.Contains("partialFilterExpression") && indexDoc["partialFilterExpression"].IsBsonDocument)
{
    createIndexOptions.PartialFilterExpression = indexDoc["partialFilterExpression"].AsBsonDocument;
}
```

### 4. ç´¢å¼•åˆ›å»ºå’Œé”™è¯¯å¤„ç†
```csharp
try
{
    // åˆ›å»ºç´¢å¼•æ¨¡å‹
    var indexModel = new CreateIndexModel<BsonDocument>(indexKeys, createIndexOptions);
    
    // åˆ›å»ºç´¢å¼•
    collection.Indexes.CreateOne(indexModel);
    
    string indexName = createIndexOptions.Name ?? "æœªå‘½åç´¢å¼•";
    SetStatus(string.Format("æˆåŠŸåˆ›å»ºç´¢å¼•: {0} (é›†åˆ: {1})", indexName, collectionName), Color.Green);
    createdCount++;
}
catch (Exception indexEx)
{
    string indexName = "æœªçŸ¥ç´¢å¼•";
    if (indexDoc.Contains("name") && indexDoc["name"].IsString)
    {
        indexName = indexDoc["name"].AsString;
    }
    SetStatus(string.Format("åˆ›å»ºç´¢å¼• {0} å¤±è´¥: {1}", indexName, indexEx.Message), Color.Red);
    skippedCount++;
}
```

## å·¥ä½œæµç¨‹

### 1. æ•°æ®å¯¼å…¥æµç¨‹
1. **æ‰«ææ–‡ä»¶**: è¯†åˆ«æ•°æ®æ–‡ä»¶(.json/.bson)å’Œmetadataæ–‡ä»¶(.metadata.json)
2. **æ˜¾ç¤ºç¡®è®¤**: åœ¨ç¡®è®¤å¯¹è¯æ¡†ä¸­æ˜¾ç¤ºå°†è¦å¯¼å…¥çš„æ–‡ä»¶åˆ—è¡¨
3. **å¯¼å…¥æ•°æ®**: å…ˆå¯¼å…¥é›†åˆæ•°æ®
4. **å¯¼å…¥ç´¢å¼•**: æ•°æ®å¯¼å…¥æˆåŠŸåï¼Œè‡ªåŠ¨æŸ¥æ‰¾å¹¶å¯¼å…¥ç´¢å¼•é…ç½®

### 2. ç´¢å¼•å¯¼å…¥æµç¨‹
1. **æ£€æµ‹metadataæ–‡ä»¶**: æŸ¥æ‰¾ä¸é›†åˆåŒåçš„.metadata.jsonæ–‡ä»¶
2. **è§£æç´¢å¼•å®šä¹‰**: è§£ææ–‡ä»¶ä¸­çš„indexesæ•°ç»„
3. **è·³è¿‡é»˜è®¤ç´¢å¼•**: è‡ªåŠ¨è·³è¿‡_id_ç´¢å¼•
4. **åˆ›å»ºè‡ªå®šä¹‰ç´¢å¼•**: é€ä¸ªåˆ›å»ºç”¨æˆ·å®šä¹‰çš„ç´¢å¼•
5. **æŠ¥å‘Šç»“æœ**: ç»Ÿè®¡åˆ›å»ºæˆåŠŸå’Œå¤±è´¥çš„ç´¢å¼•æ•°é‡

### 3. é”™è¯¯å¤„ç†æœºåˆ¶
1. **æ–‡ä»¶çº§é”™è¯¯**: metadataæ–‡ä»¶ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯æ—¶è·³è¿‡ç´¢å¼•å¯¼å…¥
2. **ç´¢å¼•çº§é”™è¯¯**: å•ä¸ªç´¢å¼•åˆ›å»ºå¤±è´¥æ—¶ç»§ç»­å¤„ç†å…¶ä»–ç´¢å¼•
3. **è¯¦ç»†æ—¥å¿—**: æ¯ä¸ªæ“ä½œéƒ½æœ‰è¯¦ç»†çš„çŠ¶æ€åé¦ˆ
4. **ä¼˜é›…é™çº§**: ç´¢å¼•å¯¼å…¥å¤±è´¥ä¸å½±å“æ•°æ®å¯¼å…¥çš„æˆåŠŸ

## ç”¨æˆ·ç•Œé¢æ”¹è¿›

### 1. ç¡®è®¤å¯¹è¯æ¡†å¢å¼º
- **æ–‡ä»¶åˆ†ç±»æ˜¾ç¤º**: 
  - ğŸ“„ æ•°æ®æ–‡ä»¶ (.json/.bson)
  - ğŸ”§ ç´¢å¼•é…ç½®æ–‡ä»¶ (.metadata.json)
- **åŠŸèƒ½è¯´æ˜**: æ˜ç¡®æç¤ºå°†åŒæ—¶å¯¼å…¥æ•°æ®å’Œç´¢å¼•é…ç½®ä¿¡æ¯
- **è§†è§‰åŒºåˆ†**: ä½¿ç”¨å›¾æ ‡å’Œé¢œè‰²åŒºåˆ†ä¸åŒç±»å‹çš„æ–‡ä»¶

### 2. çŠ¶æ€ä¿¡æ¯å¢å¼º
- **ç´¢å¼•åˆ†æ**: "æ­£åœ¨åˆ†æ collection.metadata.json ä¸­çš„ç´¢å¼•ä¿¡æ¯..."
- **ç´¢å¼•åˆ›å»º**: "æˆåŠŸåˆ›å»ºç´¢å¼•: idx_name (é›†åˆ: collection)"
- **ç»Ÿè®¡ä¿¡æ¯**: "é›†åˆ collection ç´¢å¼•å¯¼å…¥å®Œæˆ: æ€»è®¡ 3, åˆ›å»º 2, è·³è¿‡ 1"
- **é¢œè‰²ç¼–ç **: 
  - ğŸŸ¢ ç»¿è‰²: æˆåŠŸæ“ä½œ
  - ğŸŸ  æ©™è‰²: è­¦å‘Šä¿¡æ¯
  - ğŸ”´ çº¢è‰²: é”™è¯¯ä¿¡æ¯
  - ğŸ”µ è“è‰²: è¿›åº¦ä¿¡æ¯

### 3. é”™è¯¯ä¿¡æ¯ä¼˜åŒ–
- **å…·ä½“é”™è¯¯**: æ˜¾ç¤ºå…·ä½“çš„ç´¢å¼•åç§°å’Œé”™è¯¯åŸå› 
- **ç»§ç»­æ‰§è¡Œ**: å•ä¸ªç´¢å¼•å¤±è´¥ä¸ä¸­æ–­æ•´ä¸ªå¯¼å…¥è¿‡ç¨‹
- **æœ€ç»ˆç»Ÿè®¡**: æ˜¾ç¤ºæˆåŠŸå’Œå¤±è´¥çš„ç´¢å¼•æ•°é‡

## æ”¯æŒçš„ç´¢å¼•ç±»å‹ç¤ºä¾‹

### 1. åŸºæœ¬ç´¢å¼•
```json
{
  "key": { "username": 1 },
  "name": "idx_username_1",
  "unique": true
}
```

### 2. å¤åˆç´¢å¼•
```json
{
  "key": { "category": 1, "createdAt": -1 },
  "name": "idx_category_1_createdAt_-1"
}
```

### 3. TTLç´¢å¼•
```json
{
  "key": { "expireAt": 1 },
  "name": "idx_expireAt_1",
  "expireAfterSeconds": 3600
}
```

### 4. åœ°ç†ç©ºé—´ç´¢å¼•
```json
{
  "key": { "location": "2dsphere" },
  "name": "idx_location_2dsphere"
}
```

### 5. éƒ¨åˆ†ç´¢å¼•
```json
{
  "key": { "email": 1 },
  "name": "idx_email_1_partial",
  "partialFilterExpression": { "email": { "$exists": true } }
}
```

### 6. ç¨€ç–ç´¢å¼•
```json
{
  "key": { "phone": 1 },
  "name": "idx_phone_1",
  "sparse": true
}
```

## å…¼å®¹æ€§å’Œé™åˆ¶

### 1. å…¼å®¹æ€§
- **MongoDBç‰ˆæœ¬**: æ”¯æŒMongoDB 3.0+çš„æ‰€æœ‰ç´¢å¼•ç±»å‹
- **å¯¼å‡ºå·¥å…·**: å…¼å®¹`mongodump`å¯¼å‡ºçš„metadata.jsonæ ¼å¼
- **å­—ç¬¦ç¼–ç **: æ”¯æŒUTF-8ç¼–ç çš„metadataæ–‡ä»¶

### 2. å½“å‰é™åˆ¶
- **æ–‡æœ¬ç´¢å¼•**: æš‚ä¸æ”¯æŒå…¨æ–‡ç´¢å¼•(text index)
- **å“ˆå¸Œç´¢å¼•**: æš‚ä¸æ”¯æŒå“ˆå¸Œç´¢å¼•(hashed index)
- **é€šé…ç¬¦ç´¢å¼•**: æš‚ä¸æ”¯æŒé€šé…ç¬¦ç´¢å¼•(wildcard index)

### 3. æ‰©å±•æ€§
- ä»£ç ç»“æ„æ”¯æŒè½»æ¾æ·»åŠ æ–°çš„ç´¢å¼•ç±»å‹
- é”™è¯¯å¤„ç†æœºåˆ¶ç¡®ä¿å‘åå…¼å®¹æ€§
- æ¨¡å—åŒ–è®¾è®¡ä¾¿äºåŠŸèƒ½æ‰©å±•

## æ€§èƒ½è€ƒè™‘

### 1. ç´¢å¼•åˆ›å»ºæ€§èƒ½
- **åå°åˆ›å»º**: æ”¯æŒbackgroundé€‰é¡¹ï¼Œé¿å…é˜»å¡æ•°æ®åº“æ“ä½œ
- **æ‰¹é‡å¤„ç†**: é€ä¸ªåˆ›å»ºç´¢å¼•ï¼Œé¿å…å†…å­˜å‹åŠ›
- **é”™è¯¯éš”ç¦»**: å•ä¸ªç´¢å¼•å¤±è´¥ä¸å½±å“å…¶ä»–ç´¢å¼•

### 2. å¯¼å…¥æ€§èƒ½ä¼˜åŒ–
- **æ•°æ®ä¼˜å…ˆ**: å…ˆå¯¼å…¥æ•°æ®ï¼Œå†åˆ›å»ºç´¢å¼•ï¼Œæé«˜æ’å…¥æ€§èƒ½
- **çŠ¶æ€åé¦ˆ**: å®æ—¶æ˜¾ç¤ºè¿›åº¦ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- **èµ„æºç®¡ç†**: åŠæ—¶é‡Šæ”¾æ–‡ä»¶å¥æŸ„å’Œå†…å­˜èµ„æº

## ä½¿ç”¨å»ºè®®

### 1. æœ€ä½³å®è·µ
- **å¤‡ä»½éªŒè¯**: å¯¼å…¥å‰ç¡®è®¤metadata.jsonæ–‡ä»¶çš„å®Œæ•´æ€§
- **ç´¢å¼•è§„åˆ’**: å¤§æ•°æ®é›†å»ºè®®ä½¿ç”¨backgroundé€‰é¡¹åˆ›å»ºç´¢å¼•
- **é”™è¯¯ç›‘æ§**: å…³æ³¨çŠ¶æ€æ ä¿¡æ¯ï¼ŒåŠæ—¶å¤„ç†ç´¢å¼•åˆ›å»ºé”™è¯¯

### 2. æ•…éšœæ’é™¤
- **æƒé™é—®é¢˜**: ç¡®ä¿æ•°æ®åº“ç”¨æˆ·æœ‰åˆ›å»ºç´¢å¼•çš„æƒé™
- **å†…å­˜ä¸è¶³**: å¤§ç´¢å¼•åˆ›å»ºæ—¶å¯èƒ½éœ€è¦æ›´å¤šå†…å­˜
- **é‡å¤ç´¢å¼•**: é¿å…åˆ›å»ºé‡å¤çš„ç´¢å¼•å®šä¹‰

### 3. ç»´æŠ¤å»ºè®®
- **å®šæœŸæ£€æŸ¥**: å¯¼å…¥åéªŒè¯ç´¢å¼•æ˜¯å¦æ­£ç¡®åˆ›å»º
- **æ€§èƒ½ç›‘æ§**: ç›‘æ§ç´¢å¼•å¯¹æŸ¥è¯¢æ€§èƒ½çš„å½±å“
- **æ¸…ç†æ— ç”¨ç´¢å¼•**: å®šæœŸæ¸…ç†ä¸å†ä½¿ç”¨çš„ç´¢å¼•

## æ€»ç»“

ç´¢å¼•å¯¼å…¥åŠŸèƒ½æä¾›äº†ï¼š

1. **å®Œæ•´æ€§**: åŒæ—¶å¯¼å…¥æ•°æ®å’Œç´¢å¼•ï¼Œå®Œæ•´æ¢å¤é›†åˆç»“æ„
2. **è‡ªåŠ¨åŒ–**: è‡ªåŠ¨æ£€æµ‹å’Œè§£æmetadataæ–‡ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
3. **å®¹é”™æ€§**: å®Œå–„çš„é”™è¯¯å¤„ç†ï¼Œå•ä¸ªç´¢å¼•å¤±è´¥ä¸å½±å“æ•´ä½“å¯¼å…¥
4. **å¯è§†åŒ–**: æ¸…æ™°çš„ç”¨æˆ·ç•Œé¢å’ŒçŠ¶æ€åé¦ˆ
5. **å…¼å®¹æ€§**: æ”¯æŒmongodumpæ ‡å‡†æ ¼å¼ï¼Œä¸ç°æœ‰å·¥å…·å…¼å®¹

è¿™ä¸ªåŠŸèƒ½ç‰¹åˆ«é€‚åˆï¼š
- æ•°æ®åº“è¿ç§»åœºæ™¯
- å¼€å‘ç¯å¢ƒæ•°æ®æ¢å¤
- å¤‡ä»½æ•°æ®çš„å®Œæ•´è¿˜åŸ
- é›†åˆç»“æ„çš„æ‰¹é‡å¤åˆ¶

é€šè¿‡è¿™ä¸ªåŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥ä¸€é”®å®Œæˆæ•°æ®å’Œç´¢å¼•çš„å®Œæ•´å¯¼å…¥ï¼Œå¤§å¤§ç®€åŒ–äº†MongoDBæ•°æ®è¿ç§»å’Œæ¢å¤çš„å·¥ä½œæµç¨‹ã€‚