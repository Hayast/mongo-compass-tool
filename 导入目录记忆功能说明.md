# 导入目录记忆功能说明

## 功能概述

为"导入目录数据"功能添加了目录记忆功能，能够记住用户上一次选择的导入目录，并在下次打开导入对话框时自动定位到该目录，提升用户体验。

## 主要功能

### 1. 目录记忆
- **自动保存**: 用户选择导入目录后，系统自动保存该路径
- **自动加载**: 下次打开导入对话框时，自动定位到上次选择的目录
- **持久化存储**: 配置信息保存到用户应用数据目录，重启应用后仍然有效

### 2. 智能回退
- **目录验证**: 如果上次的目录不存在，自动尝试使用其父目录
- **错误处理**: 如果目录访问失败，会显示相应的提示信息
- **状态反馈**: 实时显示目录定位的状态信息

## 技术实现

### 1. 新增字段
```csharp
// 记忆上次选择的导入目录
private string lastImportDirectory = string.Empty;
```

### 2. 目录记忆逻辑
```csharp
// 设置初始目录为上次选择的目录
if (!string.IsNullOrEmpty(lastImportDirectory) && Directory.Exists(lastImportDirectory))
{
    folderDialog.SelectedPath = lastImportDirectory;
    SetStatus(string.Format("已定位到上次选择的目录: {0}", lastImportDirectory), Color.Blue);
}
else if (!string.IsNullOrEmpty(lastImportDirectory))
{
    // 如果上次的目录不存在了，尝试使用其父目录
    string parentDir = Path.GetDirectoryName(lastImportDirectory);
    if (!string.IsNullOrEmpty(parentDir) && Directory.Exists(parentDir))
    {
        folderDialog.SelectedPath = parentDir;
        SetStatus(string.Format("上次目录不存在，已定位到父目录: {0}", parentDir), Color.Orange);
    }
}
```

### 3. 目录保存逻辑
```csharp
// 保存本次选择的目录，供下次使用
lastImportDirectory = rootPath;
SaveLastImportDirectory();
```

## 核心方法

### 1. SaveLastImportDirectory - 保存目录配置
```csharp
private void SaveLastImportDirectory()
{
    try
    {
        string configPath = GetConfigFilePath();
        string configDir = Path.GetDirectoryName(configPath);
        
        // 确保配置目录存在
        if (!Directory.Exists(configDir))
        {
            Directory.CreateDirectory(configDir);
        }
        
        // 保存到配置文件
        File.WriteAllText(configPath, lastImportDirectory, Encoding.UTF8);
        SetStatus(string.Format("已保存导入目录配置: {0}", lastImportDirectory), Color.Green);
    }
    catch (Exception ex)
    {
        SetStatus(string.Format("保存导入目录配置失败: {0}", ex.Message), Color.Orange);
    }
}
```

### 2. LoadLastImportDirectory - 加载目录配置
```csharp
private void LoadLastImportDirectory()
{
    try
    {
        string configPath = GetConfigFilePath();
        
        if (File.Exists(configPath))
        {
            lastImportDirectory = File.ReadAllText(configPath, Encoding.UTF8).Trim();
            if (!string.IsNullOrEmpty(lastImportDirectory))
            {
                SetStatus(string.Format("已加载上次的导入目录配置: {0}", lastImportDirectory), Color.Blue);
            }
        }
    }
    catch (Exception ex)
    {
        SetStatus(string.Format("加载导入目录配置失败: {0}", ex.Message), Color.Orange);
        lastImportDirectory = string.Empty;
    }
}
```

### 3. GetConfigFilePath - 获取配置文件路径
```csharp
private string GetConfigFilePath()
{
    string appDataPath = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
    string appConfigDir = Path.Combine(appDataPath, "MongoCompass");
    return Path.Combine(appConfigDir, "last_import_directory.txt");
}
```

### 4. ClearLastImportDirectory - 清除配置
```csharp
private void ClearLastImportDirectory()
{
    try
    {
        string configPath = GetConfigFilePath();
        if (File.Exists(configPath))
        {
            File.Delete(configPath);
            lastImportDirectory = string.Empty;
            SetStatus("已清除导入目录配置", Color.Blue);
        }
    }
    catch (Exception ex)
    {
        SetStatus(string.Format("清除导入目录配置失败: {0}", ex.Message), Color.Orange);
    }
}
```

## 配置文件存储

### 1. 存储位置
- **Windows**: `%APPDATA%\MongoCompass\last_import_directory.txt`
- **路径示例**: `C:\Users\{Username}\AppData\Roaming\MongoCompass\last_import_directory.txt`

### 2. 文件格式
- **编码**: UTF-8
- **内容**: 纯文本格式，只包含目录路径
- **示例**: `D:\MongoBackup\`

### 3. 自动管理
- **创建**: 首次使用时自动创建配置目录和文件
- **更新**: 每次选择新目录时自动更新
- **清理**: 提供清除方法（可扩展为菜单功能）

## 用户体验改进

### 1. 便捷性提升
- **一键定位**: 无需重复浏览到常用的导入目录
- **路径记忆**: 系统自动记住用户的使用习惯
- **智能回退**: 目录不存在时自动尝试父目录

### 2. 状态反馈
- **定位成功**: 显示蓝色状态信息"已定位到上次选择的目录"
- **回退处理**: 显示橙色状态信息"上次目录不存在，已定位到父目录"
- **保存成功**: 显示绿色状态信息"已保存导入目录配置"

### 3. 错误处理
- **权限问题**: 捕获文件读写权限异常
- **路径问题**: 处理无效路径和不存在的目录
- **系统问题**: 处理系统级别的IO异常

## 工作流程

### 1. 应用启动
1. 构造函数调用`LoadLastImportDirectory()`
2. 从配置文件读取上次的目录路径
3. 显示加载状态信息

### 2. 首次使用
1. 用户点击"导入目录数据"
2. 打开文件夹选择对话框（默认位置）
3. 用户选择目录并确认
4. 保存选择的路径到配置文件

### 3. 再次使用
1. 用户点击"导入目录数据"
2. 系统检查上次保存的目录是否存在
3. 如果存在，直接定位到该目录
4. 如果不存在，尝试定位到父目录
5. 用户确认或选择新目录
6. 更新配置文件

## 扩展功能

### 1. 多目录记忆
- 可以扩展为记忆多个常用目录
- 提供下拉列表供用户快速选择
- 支持目录别名和标签

### 2. 配置管理界面
- 添加菜单项"清除导入目录记忆"
- 提供配置界面管理多个目录
- 支持导入/导出配置

### 3. 更智能的路径处理
- 支持相对路径和环境变量
- 自动检测移动硬盘和网络路径
- 提供路径有效性实时验证

## 安全和稳定性

### 1. 错误恢复
- 配置文件损坏时自动重置
- 路径访问异常时的优雅处理
- 权限不足时的友好提示

### 2. 数据安全
- 只保存路径信息，不涉及敏感数据
- 使用标准的应用数据目录
- 支持配置文件的手动删除

### 3. 兼容性
- 支持长路径和特殊字符
- 兼容不同版本的Windows系统
- 处理网络路径和移动设备

## 总结

目录记忆功能提供了：

1. **用户体验提升**: 减少重复操作，提高工作效率
2. **智能路径处理**: 自动处理目录不存在的情况
3. **持久化存储**: 应用重启后仍然保持用户的选择
4. **完善的错误处理**: 确保功能的稳定性和可靠性
5. **状态反馈**: 实时显示操作状态和结果

这个功能让导入数据的操作更加便捷和智能，特别适合需要频繁导入数据的用户场景。